name: Package and Release Helm Chart

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., 0.1.0)'
        required: true

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.3'

      - name: Determine version
        id: ver
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG='${{ github.event.inputs.release_tag }}'
          else
            TAG='${{ github.ref_name }}'
          fi
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          # Extract chart version from Chart.yaml for validation
          CHART_VER=$(yq -r '.version' Chart.yaml)
          echo "CHART_VER=${CHART_VER}" >> $GITHUB_OUTPUT
          echo "Using tag ${TAG} and chart version ${CHART_VER}"

      - name: Helm lint
        run: helm lint .

      - name: Package chart
        run: |
          mkdir -p dist
          helm package . -d dist
          ls -la dist

      - name: Upload chart as artifact
        uses: actions/upload-artifact@v4
        with:
          name: chart-package
          path: dist/*.tgz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.TAG }}
          name: ${{ steps.ver.outputs.TAG }}
          files: dist/*.tgz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update index.yaml
        run: |
          PKG=$(ls dist/*.tgz | head -n1)
          URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.ver.outputs.TAG }}/$(basename "$PKG")"
          yq -i \
            '.entries.limesurvey[0].urls = ["'"${URL}"'"] | .generated = now | .entries.limesurvey[0].created = now' \
            index.yaml
          echo "index.yaml updated with URL: ${URL}"

      - name: Commit index.yaml update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update index.yaml for ${% raw %}{{{% endraw %} steps.ver.outputs.TAG ${% raw %}}}{% endraw %}"
          file_pattern: index.yaml
