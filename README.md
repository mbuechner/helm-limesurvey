# LimeSurvey Helm Chart

Lightweight Helm chart to deploy LimeSurvey as two rootless containers (`nginx` + `php-fpm`) on Kubernetes, fronted on port 8080 and connected to an external MariaDB. Images can be built locally from this repo.

## Overview
- Purpose: Run LimeSurvey 6 on Kubernetes with a clean split of web (`nginx`) and app (`php-fpm`) containers.
- DB: Uses an external MariaDB. Provide credentials via a Kubernetes Secret.
- Storage: A PVC stores `upload`, `tmp`, and `application/config` for persistence.
- Rootless: Pods run as non-root (`runAsUser`/`runAsGroup` 10001, `readOnlyRootFilesystem`).

## Architecture
- `nginx` serves static content from `/var/www/html` and proxies to `php-fpm`.
- `php-fpm` holds the LimeSurvey PHP application and connects to MariaDB.
- Init container seeds the shared `webroot` and initial `application/config` into the persistent volume.
- `Service` exposes port 8080; optional `Ingress` routes traffic to it.
- Nginx configuration is provided via a Helm `ConfigMap` and mounted at `/etc/nginx/conf.d/default.conf`.

## Prerequisites
- Kubernetes cluster and `kubectl`.
- `helm` v3.
- Container registry to push your images.
- External MariaDB reachable from the cluster.

## Build Images (optional)
You can build and push images from the `images/` folder. The Makefile assumes variables:

PowerShell (Windows):
```powershell
$env:REGISTRY = "your-registry"
$env:TAG = "6"
```

If you have `make` available:
```bash
make build
make push
```

Without `make`:
```bash
# Build PHP-FPM (replace LS_ZIP_URL if needed)
docker build -t your-registry/limesurvey-phpfpm:6 \
	--build-arg LS_ZIP_URL="https://download.limesurvey.org/latest-master/limesurvey6.16.3+251215.zip" images/phpfpm

# Build Nginx
docker build -t your-registry/limesurvey-nginx:6 images/nginx

# Push
docker push your-registry/limesurvey-phpfpm:6
docker push your-registry/limesurvey-nginx:6
```

## Configuration
Key options from `values.yml`:
- **images.nginx.repository/tag/pullPolicy**: Nginx image location.
- **images.php.repository/tag/pullPolicy**: PHP-FPM image location.
- **service.type/port**: Defaults to `ClusterIP` on port `8080`.
- **ingress.enabled/className/annotations/hosts/tls**: Disabled by default; TLS intentionally empty.
- **mariadb.enabled**: Set to `true` to deploy an internal MariaDB via Bitnami subchart.
- **mariadb.host/port/database/username**: External DB connection settings when `mariadb.enabled=false`.
- **mariadb.auth.database/username/password**: Passed to the Bitnami subchart when `mariadb.enabled=true` (password may be autogenerated if left empty).
- **mariadb.existingSecret**: Name of the Secret containing `DB_PASSWORD` (and optionally `ADMIN_PASSWORD`).
- **persistence.enabled/size/accessModes/storageClassName**: PVC for app data under subPaths `upload`, `tmp`, `config`.
- **podSecurityContext / securityContext / runAsUser / runAsGroup**: Rootless, hardened defaults.
- **resources**: Set resource requests/limits as needed.

## Secrets
Provide DB and initial admin credentials via a Secret referenced by `mariadb.existingSecret`.

Option A — create Secret with Helm (quick start):
```yaml
secret:
	create: true
	DB_PASSWORD: "strong-db-password"
	ADMIN_PASSWORD: "strong-admin-password"
mariadb:
	existingSecret: "limesurvey-db"
```

Option B — create Secret yourself:
```bash
kubectl create secret generic limesurvey-db \
	--from-literal=DB_PASSWORD=strong-db-password \
	--from-literal=ADMIN_PASSWORD=strong-admin-password \
	-n your-namespace
```

## Install
This chart lives at the repository root. The Makefile references `charts/limesurvey`, but the actual chart files are at `./`. Prefer the direct Helm commands below.

By default, embedded MariaDB is enabled and secrets are auto-generated on first install if not provided.

```bash
# Install
helm install limesurvey . \
	-n limesurvey --create-namespace \
	--set images.php.repository=your-registry/limesurvey-phpfpm \
	--set images.php.tag=6 \
	--set images.nginx.repository=your-registry/limesurvey-nginx \
	--set images.nginx.tag=6 \
	-f values.yml

# Upgrade
helm upgrade limesurvey . \
	-n limesurvey \
	--set images.php.repository=your-registry/limesurvey-phpfpm \
	--set images.php.tag=6 \
	--set images.nginx.repository=your-registry/limesurvey-nginx \
	--set images.nginx.tag=6 \
	-f values.yml
```

## Access
- Service: `ClusterIP` on port 8080. Use an Ingress or port-forward:
```bash
kubectl -n limesurvey port-forward svc/limesurvey 8080:8080
```
Open http://localhost:8080
	create: true
	# Leave empty to auto-generate strong random values on first install
	DB_PASSWORD: ""
	ADMIN_PASSWORD: ""
ingress:
	enabled: true
	className: "nginx"
	hosts:
		- host: limesurvey.example.org
			paths:
				- path: /
					pathType: Prefix
```

## Persistence
- PVC: `limesurvey-data` (name rendered by the chart) stores LimeSurvey data.
- Subpaths mapped:
	- `upload` → `/var/www/html/upload`
	- `tmp` → `/var/www/html/tmp`
	- `config` → `/var/www/html/application/config`
- On first run, the init container seeds `application/config` if `config.php` is missing.

## Nginx ConfigMap
- The chart uses a ConfigMap (`templates/configmap-nginx.yml`) that mounts to `/etc/nginx/conf.d/default.conf` in the `nginx` container.
- This overrides the config shipped in the image, allowing environment-specific changes without rebuilding.
- If you prefer to use the image’s config only, remove the `nginx-conf` volume and mount from `templates/deployment.yml` and delete the ConfigMap template.

## Health & Probes
- Readiness/Liveness: HTTP GET `/` on port 8080.

## Security
## OpenShift Builds (optional)
This chart can create OpenShift ImageStreams and BuildConfigs when `openshift.enabled=true`.

Values:
- **openshift.enabled**: Turn on ImageStreams/BuildConfigs.
- **openshift.sourceRepo/sourceRef**: Git repository and branch/ref to build from.
- **openshift.tag**: Output ImageStream tag (default `latest`).
- **openshift.lsZipUrl**: LimeSurvey ZIP URL passed as a build-arg for PHP-FPM.

Apply and trigger builds:
```bash
# Render and apply OpenShift resources
helm template limesurvey . -f values.yml --set openshift.enabled=true | oc apply -f -

# Start builds
oc start-build limesurvey-nginx
oc start-build limesurvey-phpfpm

# Watch build logs
oc logs -f bc/limesurvey-nginx
oc logs -f bc/limesurvey-phpfpm
```

After successful builds, set chart images to reference the ImageStreams (or rely on your OpenShift registry integration).
- Runs as non-root (UID/GID 10001), drops all capabilities, read-only root FS (with writable `tmp`, `run`, and `nginx-cache`).

## Embedded MariaDB (optional)
Enable the bundled MariaDB (official image) and provide credentials via your existing Secret:
```yaml
mariadb:
	enabled: true
	database: limesurvey
	username: limesurvey
	image:
		repository: mariadb
		tag: "11.8"
```

Provide the DB password in your existing Secret (same as app uses), or keep defaults to auto-generate:
```bash
kubectl create secret generic limesurvey-db \
	--from-literal=DB_PASSWORD=strong-db-password \
	-n limesurvey
```

When `mariadb.enabled=true`:
- App connects to service `CHART-FULLNAME-mariadb` (e.g., `limesurvey-mariadb`) on port `3306`.
- MariaDB is initialized with `MARIADB_DATABASE`, `MARIADB_USER`, and `MARIADB_PASSWORD` (from the Secret key `DB_PASSWORD`).
- A random root password is used (`MARIADB_RANDOM_ROOT_PASSWORD=yes`).
- If `secret.create=true` and passwords are empty, the chart generates strong random `DB_PASSWORD` and `ADMIN_PASSWORD` on first install and preserves them on upgrades.
- Optionally enable persistence at `mariadb.persistence.*` to keep DB data across restarts.

## Troubleshooting
- **DB connection**: Verify `mariadb.host`, `port`, firewall/CNI reachability, and `DB_PASSWORD` in the Secret.
- **PVC pending**: Check `storageClassName` and permissions; set an existing StorageClass or leave empty for default.
- **Ingress 404**: Confirm correct hostname and class; check controller logs.
- **Config changes not applied**: If using the ConfigMap, ensure the Deployment rolled and that `default.conf` is mounted via `subPath`.

## Uninstall
```bash
helm uninstall limesurvey -n limesurvey
```

## Chart Metadata
- Name: `limesurvey`
- Type: `application`
- Version: `0.1.0`
- App Version: `6`

---
This chart is provided as a starting point; adapt images, security settings, and ingress to your environment.